# לוח שנה עברי
## מה הפרויקט הזה?
זהו אתר המחשב תאריך עברי ואת מועדי ישראל על בסיס התאריך הלועזי. בנוסף, האתר מציג את זמני הזריחה והשקיעה על בסיס קווי אורך ורוחב של כל עיר. בכך, האתר מאפשר שימוש גם במצב לא מקוון וללא חיבור לאינטרנט.

מסמך זה מפרט את צורת החישוב של התאריך העברי על כלל כלליו ומציג דוגמאות להמחשת התהליך.

> [!TIP]
> לאורך מסמך זה תוצג דוגמה לחישוב תאריך עברי של התאריך הלועזי 2.2.2022. הדוגמאות יהיו במסגרת כזו ותהיה להן כותרת **דוגמה**.

## איך זה עובד?
לצורך ההסבר נעבוד בצמוד לקוד באמצעות הטמעה של חלקים חשובים ממנו.

הקוד עצמו מתחיל בפונקציית `()runAll` אשר קוראת לכלל הפונקציות בקוד ולבסוף משימה את התוצאות במקומות המתאימים באתר.

בשביל שיהיה קל יותר לעקוב, כל פונקציה פנימית בפונקציה הראשית תסומן במספור משלה, כלומר כאשר נדבר על הפונקציה `()getYear` נמספר אותה ב-1, את `calcRiseSet(isRise, id)` ב-2 וכך הלאה...
### חישוב תאריך עברי
ראשית, אנו מגדירים את התאריך והחודש העבריים להיות בעלי ערך ברירת מחדל של 1.

#### 1. פונקציית `()getYear`
פונקציה זו תפקידה להשיג את התאריך הלועזי ואת הזמן (שעות ודקות) כרגע. הנתונים האלו נשמרים בזיכרון הלוקלי של האתר.

#### 2. פונקציית `calcRiseSet(isRise, id)`
פונקציה זו מקבלת משתנה בוליאני האם מחשבים זמן זריחה ואת שם המשתנה בזיכרון הלוקלי אליו נשמור את הזמן. היא מחשבת את זמן הזריחה או השקיעה בהתאם לפרמטר שהועבר לה, והיא שומרת אותו במשתנה מתאים בזיכרון הלוקלי.

החישוב נפתח בהשגת קווי האורך והרוחב של העיר שנבחרה בהגדרות. לאחר מכן מוגדרים הקבועים:
```js
const toRad = Math.PI / 180;
const toDeg = 180 / Math.PI;
const zenith = 90.8;
```
כאשר השניים הראשונים הם מעבר בין מעלות לרדיאנים ובין רדיאנים למעלות בהתאמה. המשתנה השלישי הינו הזווית של השמש ביחס לכדור הארץ. מאחר שבשקיעה ובזריחה השמש אופקית, אזי הזווית היא $90\degree$. עם זאת, כיוון שבמעבר קרני השמש באטמוספירה קורית שבירה, אזי הזווית האמיתית לזריחה ושקיעה היא $90\degree 50\prime$[^1], כאשר בהמרה לזווית במעלות:

$$50/60\approx0.8333 \rightarrow 90\degree 50\prime\approx90.8\degree$$

לאחר מכן מוחזרים היום, החודש והשנה של היום הנבחר.

כעת נתעסק בחישוב הזמנים:

א. ראשית יש לקבוע האם אנו בשעון חורף או קיץ.

לשם כך נבדוק אם אנו בין מרץ לאוקטובר (לא כולל) - אם כן אזי אנו בשעון קיץ.

אם לא אז נבדוק אם אנו בחודש מרץ - אם כן נמצא את יום שישי לפני יום ראשון האחרון בחודש מרץ ואם היום הוא אחריו אזי אנו כבר בשעון קיץ.

באופן דומה, נבדוק אם אנו בחודש אוקטובר - אם כן אז נמצא את יום ראשון האחרון של אותו חודש ואם אנו לפניו אזי אנו עדיין בשעון קיץ. [^3]

> [!TIP]
> **דוגמה - ה-2.2.2022**
> 
> החישוב למשל של יום שישי לפני יום ראשון האחרון של חודש מרץ עבור שנת 2022:
> ```js
> var d = new Date();
> d.setFullYear(year, 2, 31); //year = 2022
> var fridayBeforeSunday = d.getDate() - d.getDay() - 2;
> ```
> כאשר אנו מגדירים תאריך חדש בתור ה-31 במרץ (הקוד כתוב ב-JS ובו חודשים מסומנים בין 0 ל-11). יום שישי הרלוונטי מתקבל באמצעות חיסור של היום בשבוע (ראשון - 0, שני - 1...) מ-31 ועוד חיסור של 2 בשביל להגיע מראשון האחרון ליום שישי. כך מתקבל התאריך הלועזי של יום שישי לפני יום ראשון האחרון של חודש מרץ.
>
> במקרה שלנו:
> 
> `fridayBeforeSunday = 31 - 4 - 2 = במרץ 25`

 ב. לאחר מכן מבוצע חישוב של היום בשנה (1 זה ה-1/1, 2 זה ה-2/1... המספר של היום הוא שלם בין 1 ל-365 (או 366 בשנה מעוברת)), חישובי שעות, תיקונים שלהם ועוד.[^2]

 ג. השעה של הזריחה/השקיעה נשמר במשתנה `id` בזיכרון הלוקלי.


 #### 3. פונקציית `()getPassover`

פונקציה זו מחשבת את היום בחודש מרץ בו יחול פסח השנה. הפונקציה מבוססת על נוסחת גאוס לחישוב התאריך של פסח.[^4]

הרעיון שעומד בבסיס הקוד הינו לחשב את פסח כיוון שיש לו נוסחה מוגדרת למתי הוא יחול, ולאחר מכן לחשב את שאר המועדים בשנה.

הקוד של הפונקציה הינו:
```js
function getPassover(){
	passoverMonth = 3;
	var A = parseInt(year) + 3760;//tizen.time.getCurrentDateTime().getFullYear() + 3760;
	var a = (12 * A + 17) % 19;
	var b = A % 4;
	var x = 32 + (4343/98496) + (1 + 272953/492480) * a + b / 4 - (313 / 98496) * A;
	var c = (3 * A + 5 * b + parseInt(x / 1) + 5) % 7;
	
	if(c == 2 || c == 4 || c == 6){
		passover = 1 + parseInt(x / 1);
	} else if (c == 1 && a > 6 && x % 1 >= (1367/2160)){
		passover = 2 + parseInt(x / 1);
	} else if(c == 0 && a > 11 && x % 1 >= (23269 / 25920)){
		passover = 1 + parseInt(x / 1);
	} else 
		passover = parseInt(x / 1);

	passover += 13;
	
	if(passover > 31){
		passover -= 31;
		passoverMonth += 1;
	}
}
```

כעת נעבור על הקוד בצמוד לנוסחה:

א. תחילה, יש לחשב את השנה העברית. אנו יודעים כי קיים הפרש של 3760 שנים בין השנה הלועזית לעברית ולכן נוסיף הפרש זה.

ב. לאחר מכן עלינו לחשב את השאריות של הביטויים הבאים:

$$a=\left[\frac{12A+17}{19}\right]_r \enspace;\enspace b = \left[\frac{A}{4}\right]_r$$

כאשר $[]_r$ מסמן לקיחת השארית של הביטוי.

ג. כעת מתקיים השיוויון הבא:

$$M+m = 32 + \frac{4343}{98496} + \left(1+\frac{272953}{492480}\right)a+\frac{b}{4}-\left(\frac{313}{98496}\right)A$$

כאשר $M$ הוא החלק השלם של הביטוי באגף ימין, ו- $m$ הוא השארית של הביטוי באגף ימין.

ד. אם כן, פסח, אשר חל בט"ו ניסן, יחול ב- $M$ במרץ, אלא אם מתקיים אחד משלושת המקרים היחודיים הבאים:
נגדיר את:

$$c=\left[\frac{3A+5b+M+5}{7}\right]_r$$

&emsp;1. אם $c=2,4,6$ אזי פסח יחול ב- $M+1$ במרץ.

&emsp;2. אם $c=1, a>6, m>=\frac{1367}{2160}$, אזי פסח יחול ב- $M+2$ במרץ.

&emsp;3. אם $c=0,a>11,m>=\frac{23269}{25920}$, אזי פסח יחול ב- $M+1$ במרץ.

ה. נוסיף 13 ימים הנובעים מהמעבר בין הלוח היוליאני ללוח הגרגוריאני.[^5]

ו. אם הגענו למצב בו פסח חל בתאריך שמעבר ל-31 ימים, אזי פסח חל בחודש אפריל ולא מרץ ולכן יש לחסר 31 יום מהתאריך של פסח ולהוסיף 1 לחודש בו חל פסח.

> [!TIP]
> **דוגמה - ה-2.2.2022**
>
> א. השנה העברית היא `2022 + 3760 = 5782 = התשפב`
>
> ב. נחשב את השאריות ונקבל:
>
> $$a = 13 \enspace;\enspace b = 2$$
>
> ג. נחשב את השיוויון ונקבל:
>
> $$M + m = 34 + 0.3752..$$
>
> ד. נחשב את הביטוי ל-$c$:
>
> $$c = 0$$
>
> נשים לב שאין עמידה בתנאי השלישי המתאים ל-$c=0$ ולכן פסח יחול ב-34 במרץ.
>
> ה. נוסיף 13 ימים ונקבל שפסח יחול ב-47 במרץ.
>
> ו. עברנו את 31 ימים בחודש מרץ, ולכן נחסר אותם ונקבל שפסח חל ב-16 באפריל.

 > [!NOTE]
> ההסברים שיובאו להלן מבוססים על מדריך שנכתב באתר [ויקישיבה](https://www.yeshiva.org.il/wiki/index.php/%D7%9E%D7%93%D7%A8%D7%99%D7%9A_%D7%9C%D7%94%D7%9B%D7%A0%D7%AA_%D7%9C%D7%95%D7%97_%D7%A9%D7%A0%D7%94_%D7%A2%D7%91%D7%A8%D7%99)

#### 4. פונקציית `()getRoshHashana`

כעת נרצה למצוא מתי יחול ראש השנה של השנה. כמו קודם גם כעת נסתכל על הקוד ולאחר מכן נסביר אותו:

```js
function getRoshHashana(){
	var daysBetween = 163;
	
	if(passoverMonth == 3)
		daysBetween -= 31 - passover;
	else
		daysBetween -= 30 - passover;
	roshHashana = 1;
	roshHashanaMonth = passoverMonth + 1;
	
	while((daysBetween > 31 && (roshHashanaMonth == 5 || roshHashanaMonth == 7 || roshHashanaMonth == 8 || roshHashanaMonth == 10)) || (daysBetween > 30 && (roshHashanaMonth == 4 || roshHashanaMonth == 6 || roshHashanaMonth == 9))){
		switch(roshHashanaMonth){
			case 5:
			case 7:
			case 8:
			case 10:
				daysBetween -= 31;
				break;
			case 4:
			case 6:
			case 9:
				daysBetween -= 30;
				break;
		}
		roshHashanaMonth++;
	}
	
	roshHashanaDay = daysBetween;
}
```

א. בשלב הראשון אנו מגדירים משתנה המכיל את מספר הימים בין פסח לראש השנה לאחריו שהוא 163 ימים.

ב. בשביל לחשב את היום שיחול בו ראש השנה עלינו לחסר מ-163 את מספר הימים בין פסח לסוף החודש שבו הוא חל.

ג. לאחר מכן אנו מגדירים משתנים ליום והחודש הלועזיים בו חל ראש השנה. לאחר החישוב בשלב ב', נגדיר להם ערכי ברירת מחדל של ה-1 לחודש שאחרי החודש בו חל פסח.

ד. כעת עלינו להוריד חודשים שלמים ממספר הימים שנשארו עד שנגיע למצב בו הגענו לחודש שמספר הימים שנשארו עד ראש השנה קטן/שווה למספר הימים שיש בו. לפיכך נרוץ בלולאה ונחסר את מספר הימים שיש בכל חודש עד שהתנאי יתקיים, כאשר בכל איטרציה נזכור להוסיף 1 לחודש בו חל ראש השנה.

ה. מכשהגענו למספר ימים שקטן ממספר הימים בחודש אליו הגענו, מספר הימים שנשארו מבטאים למעשה את התאריך הלועזי בו יחול ראש השנה.

> [!TIP]
> **דוגמה - ה-2.2.2022**
>
> א. מספר הימים בין פסח לראש השנה הינו 163 ימים.
>
> ב. פסח חל ב-16 באפריל ולכן נחסר מ-163 את $30-16=14$ ונקבל שנשארו לנו 149 ימים עד ראש השנה.
>
> ג. לעת עתה ראש השנה חל ב-1 במאי 2022.
>
> ד. נוריד 31 ימים של חודש מאי, 30 ימים של חודש יוני, 31 ימים של חודש יולי, 31 ימים של חודש אוגוסט.
>
> ה. נשארנו עם 26 ימים אשר קטנים מ-30 ימים שיש בחודש ספטמבר. לפיכך, ראש השנה ב-2022 חל ב-26.9.2022.

> [!IMPORTANT]
> יש לשים לב כי התאריך המתקבל של ראש השנה הוא של ראש השנה **לאחר** פסח המתאים לשנה הלועזית. אי לכך, יש לבדוק האם התאריך הנוכחי הוא לפני ראש השנה הזה או לא ובהתאם לקבוע האם יש לקדם את השנה העברית ב-1. 

#### 5. פונקציית `()isBeforeRoshHashana`

פונקציה זו קובעת במשתנה בוליאני האם התאריך הנוכחי הוא אחרי ראש השנה שעתיד לחול. הפונקציה:

```js
function isBeforeRoshHashana(){
	if((parseInt(localStorage["hour"]) > parseInt(localStorage["sunset"].split(":")[0])) || (parseInt(localStorage["hour"]) == parseInt(localStorage["sunset"].split(":")[0]) && parseInt(localStorage["min"]) >= parseInt(localStorage["sunset"].split(":")[1]))){
		getNextDay();
		calcRiseSet(true, "sunrise");
		calcRiseSet(false, "sunset");
	}
	
	if(month < roshHashanaMonth)
		beforeRoshHashana = true;
	else if(month == roshHashanaMonth && day < roshHashanaDay)
		beforeRoshHashana = true;
	else
		beforeRoshHashana = false;
}
```

א. בשלב הראשון נבדוק האם היום הלועזי הנוכחי הוא אחרי השקיעה, אם כן אז נקדם את התאריך העברי ביום ונחשב שוב את זמני הזריחה והשקיעה.

ב. לאחר מכן נבדוק האם היום הוא לפני או אחרי ראש השנה שחישבנו באמצעות בדיקה אם החודש הנוכחי הוא אחרי החודש של ראש השנה, ואם הם שווים אז אם היום הנוכחי לפני היום של ראש השנה.

##### פונקציית `()getNextDay`

הפונקציה מקדמת את התאריך הלועזי ב-1 ומוודאה שהתאריך החדש תקין:

```js
function getNextDay(){
	day++;
	
	if(day > 31 && (month == 1 || month == 3 || month == 5 || month == 7 || month == 8 || month == 10)){
		day = 1;
		month++;
	} else if(day > 30 && (month == 4 || month == 6 || month == 9 || month == 11)){
		day = 1;
		month++;
	} else if(month == 2){
		if(tempYear % 4 == 0){
			if(tempYear % 100 == 0 && tempYear % 400 != 0)
				if(day > 28){
					day = 1;
					month++;
				}
			else{
				if(day > 29){
					day = 1;
					month++;
				}
			}
		} else {
			if(day > 28){
				day = 1;
				month++;
			}
		}
	} else if(month == 12 && day > 31){
		day = 1;
		month = 1;
		year++;
	}
	
	localStorage["day"] = day;
	localStorage["month"] = month;
	localStorage["year"] = year;
}
```

5.1. בשלב הראשון נעשה קידום של היום ב-1.

5.2. אם מספר היום גדול מ-31 ואנו בחודש שיש בו 31 ימים, אזי נשנה את היום להיות הראשון לחודש הבא בתור.

5.3. אחרת - אם מספר היום גדול מ-30 ואנו בחודש שיש בו 30 ימים, אזי נשנה את היום להיות הראשון לחודש הבא בתור.

5.4. אחרת - אם החודש הוא פברואר:
  
&emsp;5.4.1. אם השנה מעוברת (מתחלקת ב-4 אך לא ב-100 או מתחלקת ב-400) אזי יש 29 ימים בחודש פברואר ולכן אם יש מעל 29 ימים נעבור לראשון במרץ.

&emsp;5.4.2. אחרת השנה לא מעוברת ופברואר בעל 28 ימים ולכן אם היום הבא הוא ה-29 בפברואר נעבור לראשון במרץ.

> [!TIP]
> **דוגמה - ה-2.2.2022**
>
> א. נניח שאנו אחרי השקיעה ולכן נקרא לפונקציה שתקדם אותנו ביום (כלומר נתייחס לתאריך הלועזי כאילו הוא ה-3.2.2022).
>
> ב. התאריך הנוכחי הוא לפני ראש השנה שחל ב-26.9.2022 ולכן נשים במשתנה `true`.

#### 6. פונקציית `()getHebrewYear`

הפונקציה מחשבת את השנה העברית ועושה קריאות חוזרות במקרה הצורך:

```js
function getHebrewYear(){
	hebrewYear = parseInt(year) + 3760;
	
	if(!beforeRoshHashana){
		hebrewYear += 1;
	} else {
		year--;
		getPassover();
		getRoshHashana();
		year++;
	}	
}
```

א. הפונקציה מחשבת את השנה העברית כפי שכבר נעשה בפונקציית `()getPassover`.

ב. אם התאריך של היום הוא אחרי ראש השנה הבא אחרי פסח של השנה הלועזית הנוכחית, אזי נוסיף 1 לשנה העברית. אחרת - אנו לפני ראש השנה הזה ולכן נרצה להתייחס לראש השנה שכבר היה בתחילת שנה. לפיכך, נוריד שנה לועזית אחת, נחשב את פסח ואת ראש השנה שכבר היו ואז נחזיר 1 לשנה הלועזית.

> [!TIP]
> **דוגמה - ה-2.2.2022**
>
> א. השנה העברית היא `5782 = התשפב`.
>
> ב. התאריך הנוכחי הוא לפני ראש השנה שחל ב-26.9.2022 ולכן נתייחס לשנה כאל 2021, נחשב את פסח ונקבל שהוא היה ב-28.3.2021, נחשב את ראש השנה ונקבל שהוא היה ב-7.9.2021 ונחזיר את השנה להיות 2022.

#### 7. פונקציית `()getIsMeoobheret`

הפונקציה בודקת האם השנה היא אחת משנות `גו"ח אדז"ט` (כלומר השנים השלישית, שישית, שמינית, אחת עשרה, ארבע עשרה, שבע עשרה ותשע עשרה הן מעוברות מתוך מחזור של 19 שנים) ושומרת את זה במשתנה בוליאני:

```js
function getIsMeoobheret(){
	var meoobheret = hebrewYear % 19;
	
	isMeoobheret = meoobheret == 3 || meoobheret == 6 || meoobheret == 8 || meoobheret == 11 || meoobheret == 14 || meoobheret == 17 || meoobheret == 19;
}
```

> [!TIP]
> **דוגמה ה-2.2.2022**
>
> השנה העברית היא 5782 ולכן השארית היא 6 ולפיכך השנה מעוברת.

#### 8. פונקציית `()getMissOrFullDays`

ככלל, החודשים העבריים מקיימים את הכלל שחודש אחד מלא והבא אחריו חסר וכך הלאה. לפיכך, תשרי בעל 30 ימים, חשוון בעל 29 ימים, כסלו בעל 30 ימים וכך הלאה.

עם זאת, חשוון וכסלו הם חודשים יוצאי דופן אשר יכולים להיות גם מלאים וחסרים (ייתכן ששניהם מלאים, שניהם חסרים או חשוון חסר וכסלו מלא. **לא** ייתכן מצב בו חשוון מלא וכסלו חסר).

לכן פונקציה זו מחשבת האם חשוון חודש מלא או כסלו חודש חסר או אף אחד מהם לא מתקיים. הסיבה לשינויים האלה נובעת מכך שראש השנה של שנה זו ושל שנה הבאה עשויים לזוז ביום בשביל לעמוד בכללים שהוגדרו.

כיוון שהקוד לפונקציה זו ארוך, נעבור עליו עם ההסבר לסירוגין כאשר ראשית נסביר את קטע הקוד שיבוא ולאחר מכן נציג את הקוד.

א. תחילה נגדיר משתנים שיעזרו לנו בחישובים - היום, השעה והחלקים בהם יחול המולד של חודש תשרי של השנה ושל שנה הבאה, וכן את הימים האמיתיים בהם יחולו ראשי השנים.

```js
var roshHashanaDays;
var roshHashanaHours;
var roshHashanaParts;
var roshHashanaRealDay;

var nextRoshHashanaDays;
var nextRoshHashanaHours;
var nextRoshHashanaParts;
var nextRoshHashanaRealDay;
```

ב. בשלב השני נגדיר מספר קבועים - השלשה הראשונה הם היום, השעה והחלקים בהם התרחש המולד הראשון, הידוע בכלל "מולד בהר"ד" האומר שהמולד התרחש ביום ב', שעה ה' ו-ר"ד חלקים. השלשה השנייה היא ההפרש בין כל מולד למולד שהוא כ"ט יום, י"ב שעות ו-תשצ"ג חלקים. קבועים אלו יעזרו לנו לחשב את המולדות של ראשי השנים הרלונטיים לנו.

```js
//first molad
const firstMoladDays = 2;
const firstMoladHours = 5;
const firstMoladParts = 204;
//difference of molads
const diffMoladDays = 29;
const diffMoladHours = 12;
const diffMoladParts = 793;
```

ג. נגדיר עוד כמה דברים עבור החישוב למולדות תשרי. נתחיל בלחשב את מספר השנה במחזור של 19 שנים והאם השנה שעברה ושנה הבאה יהיו מעוברות. בנוסף, נגדיר משתנה שישמור כמה חודשים עברו מאז המולד הראשון ועד ראש השנה הנוכחי, וכן נגדיר משתנה שיכיל שיש בשנת ירח 354 ימים. באם השנה מעוברת נוסיף עוד 30 ימים של אדר א' למספר הימים שיש בשנת ירח.

```js
var meoobheret = hebrewYear % 19;
var isLastYearMeoobheret = meoobheret == 4 || meoobheret == 7 || meoobheret == 9 || meoobheret == 12 || meoobheret == 15 || meoobheret == 18 || meoobheret == 1;
var isNextYearMeoobheret = meoobheret == 2 || meoobheret == 5 || meoobheret == 7 || meoobheret == 10 || meoobheret == 13 || meoobheret == 16 || meoobheret == 18;
var pastMonthes;
var daysRegularYear = 354;

if(isMeoobheret){
	daysRegularYear += 30;
}
```

ד. נתחיל מלחשב את מספר החודשים שעברו מהמולד הראשון עד המולד של תשרי הנוכחי.

הדרך בה נעשה זאת היא לפי מחזורים של 19 שנים. לפיכך, נתחיל מלספור כמה שנים מעוברות היו עד השנה (לא כולל השנה) במחזור הנוכחי, ולצורך כך נעזר במשתנה שמכיל את מספר השנה במחזור הנוכחי. אם השנה היא שנים א', ב' או ג' אזי עברו 0 שנים מעוברות (גם ג' נכלל כי אנו מסתכלים על השנים שהיו לא כולל השנה, שהרי אנו מחשבים את המולד של השנה), אם השנה היא ד', ה' או ו' אז עברה שנה מעוברת אחת וכך הלאה.

לאחר מכן נבדוק כמה מחזורים שלמים של 19 שנים היו עד השנה הזאת ונכפיל אותם  ב-7 חודשי אדר א' שהתווספו לשנים המועברות בכל מחזור. ולבסוף נוסיף 12 חודשים לכל שנה עד השנה הזאת (לא כולל).

```js
//calc how many months have passed since first molad
if(meoobheret <= 3)
	pastMonthes = 0;
else if(meoobheret <= 6)
	pastMonthes = 1;
else if(meoobheret <= 8)
	pastMonthes = 2;
else if(meoobheret <= 11)
	pastMonthes = 3;
else if(meoobheret <= 14)
	pastMonthes = 4;
else if(meoobheret <= 17)
	pastMonthes = 5;
else if(meoobheret <= 19)
	pastMonthes = 6;
else
	pastMonthes = 7;

pastMonthes += parseInt((hebrewYear - 1) / 19) * 7;

pastMonthes += (hebrewYear - 1) * 12;
```

ה. כעת אנו מוכנים לחשב את המולד של תשרי הנוכחי.

ניקח את החלקים של המולד הראשון ונוסיף להם את מספר החלקים בין כל מולד למולד כפול מספר החודשים שעברו (שהרי המולד מתרחש כל חודש). באותו אופן נעשה לשעות ולימים.

עם זאת, סביר שמספר החלקים יעבור את הסף שמוסיף שעה (1080 חלקים שווים שעה), וכן מספר השעות יעבור את הסף שמוסיף יום (24 שעות שווה יום). לאור זאת, נוסף לשעות את החלוקה של החלקים ב-1080, ונוסיף לימים את החלוקה של השעות ב-24. בשביל לקבל את החלקים, שעות ויום בו יחול המולד, נבצע חלוקת שארית ב-1080, 24 ו-7 בהתאמה.

במידה וקיבלנו שהיום הוא 0, כלומר שבת, נבצע החלפה שלו ל-7. לכאורה, קיבלנו גם את היום בו יחול ראש השנה של השנה.

```js
//calc this year rosh hashana molad
roshHashanaParts = diffMoladParts * pastMonthes + firstMoladParts;
roshHashanaHours = diffMoladHours * pastMonthes + firstMoladHours;
roshHashanaDays = diffMoladDays * pastMonthes + firstMoladDays;

//calc the real day in the week of rosh hashana
roshHashanaHours += parseInt(roshHashanaParts / 1080);
roshHashanaParts = roshHashanaParts % 1080;
roshHashanaDays += parseInt(roshHashanaHours / 24);
roshHashanaHours = roshHashanaHours % 24;
roshHashanaDays = roshHashanaDays % 7;

if(roshHashanaDays == 0)
	roshHashanaDays = 7;

roshHashanaRealDay = roshHashanaDays;
```

ו. אף על פי שקיבלנו את המולד, ישנם עוד 4 כללים שעלינו לקחת בחשבון שעלולים לדחות את היום בו יחול ראש השנה (אמנם חישבנו בצורה אחרת את היום בו ראש השנה יחול, אך החישוב כאן רלוונטי בשביל קביעת חשוון וכסלו):

&emsp;ו.1. ראש השנה לא חל בימים א', ד' ו-ו'. אם קיבלנו שהמולד חל באחד מהימים האלה אזי ראש השנה יחול למחרת.

&emsp;ו.2. אם מספר השעות של המולד הוא גדול/שווה ל-18, זה נחשב מולד זקן (עבר שלושת רבעי יממה) וראש השנה ידחה למחרת. לאחר מכן יש לבדוק שוב את כלל ו.1.

&emsp;ו.3. אם המולד ביום ג', מספר השעות והחלקים גדול/שווה ל-9 שעות ו-204 חלקים והשנה אינה מעוברת - ראש השנה ידחה ליום ה'.

&emsp;ו.4. אם המולד ביום ב', מספר השעות והחלקים גדול/שווה ל-15 שעות ו-589 חלקים והשנה שהייתה היא מעוברת - ראש השנה ידחה למחרת, כלומר ליום ג'.

```js
if(roshHashanaRealDay == 1 || roshHashanaRealDay == 4 || roshHashanaRealDay == 6)
	roshHashanaRealDay++;

if(roshHashanaHours >= 18) {
	roshHashanaRealDay++;
	if(roshHashanaRealDay == 1 || roshHashanaRealDay == 4 || roshHashanaRealDay == 6)
	roshHashanaRealDay++;
}

if(roshHashanaDays == 3 && ((roshHashanaHours > 9) || (roshHashanaHours == 9 && roshHashanaParts >= 204)) && !isMeoobheret)
	roshHashanaRealDay = 5;

if(roshHashanaDays == 2 && ((roshHashanaHours > 15) || (roshHashanaHours == 15 && roshHashanaParts >= 589)) && isLastYearMeoobheret)
	roshHashanaRealDay = 3;

if(roshHashanaRealDay > 7)
	roshHashanaRealDay -= 7;
```

ז. באותו אופן נחשב את המולד של השנה הבאה כאשר נחסוך חישובים ונשתמש בחלקים, שעות וימים שחישבנו למולד הנוכחי. אם השנה הנוכחית מעוברת נוסיף להם 13 פעם את ההפרשים בין המולדות, אחרת נוסיף 12 פעם.

```js
//calc next year rosh hashana molad
if(isMeoobheret){
	nextRoshHashanaParts = diffMoladParts * 13 + roshHashanaParts;
	nextRoshHashanaHours = diffMoladHours * 13 + roshHashanaHours;
	nextRoshHashanaDays = diffMoladDays * 13 + roshHashanaDays;
} else {
	nextRoshHashanaParts = diffMoladParts * 12 + roshHashanaParts;
	nextRoshHashanaHours = diffMoladHours * 12 + roshHashanaHours;
	nextRoshHashanaDays = diffMoladDays * 12 + roshHashanaDays;
}
```

ח. נחזור על מחצית שלב ה' ועל שלב ו' עבור המולד של תשרי שבשנה הבאה.

ט. וכעת ניגש למלאכת חישוב החודשים החסרים והמלאים.

נוסיף ליום בו חל ראש השנה את מספר הימים שיש בשנה ירחית רגילה (354) וניקח את שארית החלוקה ב-7.

אם קיבלנו שעל פניו ראש השנה יחול אחרי היום האמיתי בו הוא אמור לחול, משמע שיש לנו יום מיותר השנה ולכן כסלו יהיה חסר.

אם קיבלנו שעל פניו ראש השנה הבא יחול לפני היום האמיתי בו הוא אמור לחול, סימן שחסר לנו יום השנה וחשוון יהיה מלא.

אחרת - הכל בסדר וחשוון יהיה חסר וכסלו יהיה מלא.

```js
//calc which month is missing or full or nothing
if((roshHashanaRealDay + daysRegularYear) % 7 > nextRoshHashanaRealDay){
	missOrFull = "K"; //Kislev is missing a day
}else if((roshHashanaRealDay + daysRegularYear) % 7 < nextRoshHashanaRealDay){
	missOrFull = "H"; //Heshvan get another day
}
else{
	missOrFull = "R"; //Regular year
}
```

> [!TIP]
> **דוגמה - ה-2.2.2022**
>
> א. נגדיר משתנים.
>
> ב. המולד הראשון היה ב-בהר"ד, ההפרש בין כל זוג מולדות הוא כ"ט ימים, י"ב שעות ו-תשצ"ג חלקים.
>
> ג. השנה מעוברת כי `5782 % 19 = 6`. לפיכך, שנה שעברה ושנה הבאה אינן מעוברות. נזכור שיש 354 ימים בשנה, אך כיוון שהשנה מעוברת נוסיף עוד 30 יום ונקבל שיש 384 ימים.
>
> ד. נחשב את מספר החודשים שעברו - השנה היא השישית במחזור ולכן היה חודש מעובר אחד במחזור הנוכחי. בנוסף, היו כבר 304 מחזורים שלמים של 19 שנים ולכן 2128 חודשים מעוברים. כמו כן, עברו 5781 שנים שהכילו (לפחות) 12 חודשים ולכן עוד 69372 חודשים. סך הכל עברו מהמולד הראשון 71501 חודשים.
>
> ה. נחשב את המולד של תשרי שחל השנה:
>
> `חלקים = 793 * 71501 + 204 = 56700497`
>
> `שעות = 12 * 71501 + 5 = 858017`
>
> `ימים = 29 * 71501 + 2 = 2073531`
>
> נמיר חלקים לשעות ושעות לימים וניקח שאריות ונקבל:
>
> `חלקים = 497`
>
> `שעות = 858017 + 52500 = 910517 ← 5`
>
> `יום = 2073531 + 37938 = 2111469 ← 3`
>
> כלומר, המולד חל ביום ג', 5 שעות ו-497 חלקים.
>
> ו. נבדוק את הכללים:
>
> &emsp;ו.1. לא מתקיים כי מותר שראש השנה יחול ביום שלישי.
>
> &emsp;ו.2. לא מתקיים כי מספר השעות לא גדול מ-18.
>
> &emsp;ו.3. לא מתקיים כי המולד אמנם חל ביום ג' אבל מספר השעות לא גדול מ-9.
>
> &emsp;ו.4. לא מתקיים כי המולד לא ביום ב'.
>
> לפיכך ראש השנה חל באותה שנה ביום ג'.
>
> ז. נחשב את המולד של שנה הבאה. השנה הנוכחית הייתה מעוברת ולכן נוסיף את ההפרש ל-13 חודשים ונקבל:
>
> `חלקים = 793 * 13 + 497 = 10806`
>
> `שעות = 12 * 13 + 5 = 161`
>
> `ימים = 29 * 13 + 3 = 380`
>
> ח. כמו קודם נבצע המרה וניקח שאריות:
>
> `חלקים = 6`
>
> `שעות = 161 + 10 = 171 ← 3`
>
> `יום = 380 + 7 = 387 ← 2`
>
> כלומר, המולד חל ביום ב', 3 שעות ו-6 חלקים.
>
> נוכל לבדוק שוב את 4 הכללים ונגלה שאף אחד מהם לא מתקיים ולכן ראש השנה של שנת התשפ"ג חל ביום ב'.
>
> ט. נבצע את התוספת של מספר הימים בשנה לראש השנה וניקח שארית חלוקה ב-7:
>
> `ראש השנה הבא = (3 + 384) % 7 = 2`
>
> קיבלנו שראש השנה הבא יחול ביום ב' בהתאם לחישוב שביצענו ולכן נסיק שהשנה היא רגילה, כלומר חשוון חסר וכסלו מלא.

#### 9. פונקציית `()getHebrewDate`

פונקציה זו מחשבת את התאריך העברי המתאים להיום ומציגה אותו באתר.

גם פונקציה זו ארוכה מעט ולכן נסביר כל חלק בה ואז נציג את הקוד הרלוונטי.

הפונקציה מבוססת על כך שאנו יודעים מתי ראש השנה חל הן בתאריך העברי (א' תשרי) והן בתאריך הלועזי (מפונקציית `()getRoshHashana`, פונקציה מספר 4 ברשימה זו).

בשלב הראשון נספור כמה ימים יש בלוח הלועזי מראש השנה עד ללתאריך הנוכחי. לאחר מכן נספור את התאריך בלוח העברי. הסיבה להפרדה היא שאין בהכרח חפיפה בין הלוחות, אך מספר הימים בין ראש השנה להיום הוא זהה ב-2 הלוחות.

א. תחילה נגדיר משתנה שיספור כמה ימים יש בין ראש השנה להיום, וכן נגדיר משתנים זמניים שימנו את החודש והשנה הלועזיים לאורך הספירה ויעזרו לנו למנות את מספר הימים הנכון שיש בכל חודש (ייתכן שנעבור שנה לועזית בין ראש השנה להיום). 

```js
var countDays = 0;
var tempMonth = roshHashanaMonth;
var tempYear = hebrewYear - 3761;
```

ב. כעת הגענו לשלב הראשון. תחילה נבדוק אם היום ראש השנה - שהרי אם כן אזי אין ימים שצריך למנות בין ראש השנה להיום. נעשה זאת באמצעות השוואה בין היום, חודש ותאריך עברי של ראש השנה לבין היום, חודש ותאריך לועזי ועוד 3761 של היום (הסיבה לתוספת של 3761 ולא 3760 היא שספרת האחדות בגימטריה של השנה החדשה (למשל בתשפ"ב זה ב' ולכן 2) נמוכה ב-1 מספרת האחדות של השנה הלועזית (למשל 2021 בהתאמה)).

אם זה לא קורה נבדוק האם אנו באותה שנה וחודש כמו ראש השנה. אם כן אז מספר הימים שיש למנות הוא המספר של היום בחודש פחות התאריך של ראש השנה.

אם אנו לא באותו חודש או אותה שנה - נמנה את מספר הימים שיש באותו חודש (30 בספטמבר ו-31 באוקטובר) פחות התאריך של ראש השנה ונוסיף 1 למניית החודש הזמני בו אנו נמצאים שכן עברנו לחודש העוקב לחודש בו חל ראש השנה.

כעת נרוץ על החודשים והשנה הזמניים שהגדרנו ונוסיף 30/31 ימים בהתאם לחודש הזמני. עבור חודש פברואר נחלק למקרה בו השנה מעוברת (מתחלקת ב-4 אך לא ב-100 או מתחלקת ב-400) ואז נוסיף 29 ימים, אחרת נוסיף 28 ימים. בחודש דצמבר נזכור להוסיף 1 גם למניית השנה הזמנית שהגדרנו.

לבסוף, נוסיף למנייה את מספר היום הנוכחי בחודש. זאת כיוון שעלינו למנות עד היום ולא עד תחילת החודש של היום.

```js
if(!(day == roshHashanaDay && month == roshHashanaMonth && year + 3761 == hebrewYear)){
	if(year + 3761 == hebrewYear && month == roshHashanaMonth && day > roshHashanaDay){
		countDays = day - roshHashanaDay;
	} else {
		tempMonth++;
		
		if(roshHashanaMonth == 9)
			countDays = 30 - roshHashanaDay ;
		else if(roshHashanaMonth == 10)
			countDays = 31 - roshHashanaDay;
		
		while(tempYear < year || (tempYear == year && tempMonth < month)){
			switch(tempMonth){
				case 1:
				case 3:
				case 5:
				case 7:
				case 8:
				case 10:
					countDays += 31;
					tempMonth++;
					break;
				case 4:
				case 6:
				case 9:
				case 11:
					countDays += 30;
					tempMonth++;
					break;
				case 2:
					if(tempYear % 4 == 0){
						if(tempYear % 100 == 0 && tempYear % 400 != 0)
							countDays += 28;
						else
							countDays += 29;
					} else {
						countDays += 28;
					}
					tempMonth++;
					break;
				case 12:
					countDays += 31;
					tempMonth = 1;
					tempYear++;
					break;
			}
		}
		
		countDays += day;
	}
}
```

ב. זהו השלב השני. נרוץ על מספר הימים שמנינו ונוסיף חודשים עבריים עד שנגיע לחודש המתאים ושם נוסיף את מספר הימים שנשארו ליום בו אנו נמצאים.

נזכר במקרים השונים הרלוונטיים ללולאה שלנו, כלומר באיזה מקרים עלינו לבצע איטרציה נוספת:

ב.1. השנה לא מעוברת, אנו בחודש אי זוגי (תשרי, כסלו (ראו תנאי ב.3), שבט,...) ונשארו 30 ימים ומעלה (הגדרנו מראש את התאריך העברי להיות ה-1 בחודש ואנו מוסיפים לו ימים ולכן התנאי הוא גדול **שווה** ולא רק גדול).

ב.2. השנה לא מעוברת, אנו בחודש זוגי (חשוון (ראו תנאי ב.4), טבת, אדר,...) ונשארו 29 ימים ומעלה.

ב.3. חשוון מלא, החודש העברי במנייה כרגע הוא חשוון ונשארו 30 ימים ומעלה.

ב.4. כסלו חסר, החודש העברי במנייה כרגע הוא כסלו ונשארו 29 ימים ומעלה.

ב.5. השנה מעוברת, אנו בחודש אי זוגי ונשארו 30 ימים ומעלה או אנו בחודש זוגי ונשארו 29 ימים ומעלה, והחודש הנוכחי במנייה כרגע הוא לפני אדר.

ב.6. השנה מעוברת, אנו בחודש אי זוגי (לא לשכוח את אדר א') ונשארו 29 ימים ומעלה או אנו בחודש זוגי ונשארו 30 ימים ומעלה, והחודש הנוכחי במנייה כרגע הוא אדר א' ומעלה.

במקרים האלו נחסר 29/30 ימים מהמנייה ונוסיף 1 למניית החודש העברי. כאשר החודשים שיש לשים לב אליהם הם: חשוון, כסלו, אב/אלול כתלות באם השנה מעוברת ובשאר החודשים יש להפריד בהתאם להאם השנה מעוברת או לא ובאיזה חודש אנו נמצאים.

> [!WARNING]
> ייתכן שהבדיקה case 12 במקרה שהשנה לא מעוברת ו-case 13 מיותרות כיוון שאם אנו בחודש תשרי של השנה הבאה, אז מספר הימים שיש למנות יהיה ביחס לראש השנה הבא.


ונזכור להוסיף את מספר הימים שנשארו לתאריך העברי.

```js
while((countDays >= 30 && hebrewMonth % 2 == 1 && !isMeoobheret)
|| (countDays >= 29 && hebrewMonth % 2 == 0 && !isMeoobheret)
|| (missOrFull == "H" && countDays >= 30 && hebrewMonth == 2)
|| (missOrFull == "K" && countDays >= 29 && hebrewMonth == 3)
|| (((countDays >= 30 && hebrewMonth % 2 == 1) || (countDays >= 29 && hebrewMonth % 2 == 0)) && hebrewMonth < 6 && isMeoobheret)
|| (isMeoobheret && hebrewMonth >= 6 && ((countDays >= 29 && hebrewMonth % 2 == 1) || (countDays >= 30 && hebrewMonth % 2 == 0)))){
	switch (hebrewMonth){
		case 2:
			if(missOrFull == "H")
				countDays -= 30;
			else
				countDays -= 29;
			hebrewMonth++;
			break;
		case 3:
			if(missOrFull == "K")
				countDays -= 29;
			else
				countDays -= 30;
			hebrewMonth++;
			break;
		case 12:
			if(isMeoobheret){
				countDays -= 30;
				hebrewMonth++;
			} else {
				countDays -= 29;
				hebrewMonth = 1;
			}
			break;
		case 13:
			countDays -= 29;
			hebrewMonth = 1;
			break;
		default:
			if(!isMeoobheret){
				if(hebrewMonth % 2 == 0)
					countDays -= 29;
				else
					countDays -= 30;
			} else {
				if(hebrewMonth < 6){
					if(hebrewMonth % 2 == 0)
						countDays -= 29;
					else
						countDays -= 30;
				} else {
					if(hebrewMonth % 2 == 0){
						countDays -= 30;
					} else {
						countDays -= 29;
					}
				}
			}
			
			hebrewMonth++;
			break;
	}
}

hebrewDay += countDays;
```

ג. לבסוף, נמיר את התאריך העברי ממספרים לאותיות, נציב במקום המתאים באתר ונשמור בזיכרון הלוקלי לחיסכון בחישוב.

```js
getHebrewDayLetters();
getHebrewMonthLetters();
getHebrewYearLetters();

document.getElementById("hebDate").innerHTML = hebrewDay + " " + hebrewMonth + " " + hebrewYear;
localStorage["hebrewDay"] = hebrewDay;
localStorage["hebrewMonth"] = hebrewMonth;
localStorage["hebrewYear"] = hebrewYear;
```

הפונקציות `()getHebrewDayLetter`, `()getHebrewMonthLetters`, `getHebrewYearLetters` ממירות את המספרים ליום, חודש ושנה באמצעות `switch case`, כאשר לחודשים יש התחשבות באם השנה מעוברת או לא, והחישוב של השנים מתבסס על חישוב הסכום עם המחוברים המקסימליים שמגיעים לשנה הנוכחית.

> [!TIP]
> **דוגמה לפונקציה `()getHebrewYearLetters` - ה-2.2.2022**
>
> אם השנה היא 5782 והסכום מתחיל מ-0, אז נתחיל בלחסר 5000 מהשנה ונוסיף את האות ה' לתאריך העברי. לאחר מכן נשארים לנו 782 ולכן נוסיף ת' כי $0+400<=782$, לאחר מכן נוסיף ש' כי $400+400>782$ אבל $400+300<=782$ וכך הלאה.

> [!TIP]
> **דוגמה - ה-2.2.2022**
>
> 



 

[^1]: 90 מעלות ו-50 דקות קשת. דקת קשת היא יחידת מידה זוויתית ששווה ל-1⁄60 מעלה ומסומנת ב-`'`.
[^2]: מבוסס על [האתר](https://edwilliams.org/sunrise_sunset_algorithm.htm) שמבוסס על Almanac for Computers מאת Nautical Almanac Office, United States Naval Observatory.
[^3]: בישראל שעון קיץ מתחיל ביום שישי לפני יום ראשון האחרון של חודש מרץ ועד ליום ראשון האחרון של חודש אוקטובר.
[^4]: מבוסס על [WikiBooks](https://en.wikibooks.org/wiki/Mathematics_of_the_Jewish_Calendar/Printable_version#Gauss'_Formula_for_the_Date_of_Pesach)
[^5]: התוספת של 13 הימים רלוונטית לתאריכים בין 1/3/1900 עד ה-28/2/2100. קיימת נוסחה כללית אשר נותנת את מספר הימים שיש להוסיף בין כל 100/200 שנים.
